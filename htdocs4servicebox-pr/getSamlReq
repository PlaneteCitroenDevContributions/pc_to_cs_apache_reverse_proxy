#! /bin/bash

# -*- mode: shell-script -*-

set -e

exec 2>/var/pc_debug/"$( basename "$0" )".log

(
    echo '==============================='
    date
    echo
    env
) 1>&2

#!!!set -x

HERE=$( dirname "$0" )

if [[ -r "${0}.env.secret" ]]
then
    source "${0}.env.secret"
fi

html_log_message () {
    echo "$@" | while read -r line
    do
       echo "<p>=== ${line} </p>"
    done
}

query_string_array_init_val=$(

    IFS='&'
    set -- ${QUERY_STRING}
    for i in "$@"
    do
       IFS='='
       set -- $i
       echo "[$1]=$2"
    done

)
eval declare -A query_string_array=( ${query_string_array_init_val} )

#
# get SAML Auth
#

# get JSESSIONID PSACOUNTRY & BIGIPSERVER cookies

_old_IFS="${IFS}"
IFS=';, ';
for i in ${HTTP_COOKIE}
do
    case "${i}" in
	JSESSIONID\=* )
	    SET_JSESSIONID="${i}"
	    ;;
	PSACountry\=* )
	    SET_PSA_COUNTRY="${i}"
	    ;;

	 BIGipServer* )
	    SET_BIGIPSERVER="${i}"
	    ;;

	* )
	    ;;
    esac
done
IFS="${_old_IFS}"

: ${PUBLIC_SERVICE_BOX_ROOT_URL:='https://public.servicebox-parts.com/'}

USERAGENT='Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:132.0) Gecko/20100101 Firefox/132.0'

test_HTTP_REQ=':status: 200
cache-control: no-cache, no-store, max-age=0
date: Sun, 10 Nov 2024 08:31:56 GMT
gigyaurl: https://fidm.eu1.gigya.com/saml/v2.0/4_orFmUKH1TrnP0kMf3hryrA/idp/sso
pc-rproxy-trace: Traffic caught at t=1731227516883954 for dev.servicebox.forumtestplanetecitroen.fr, proto https
pragma: no-cache
samllogoutrequest: hZFRa8IwEMff9ylK3tMktUobrCKITKYgm%2B5hLyOpsYa1SZdLi377RZ3gw2Cvd%2Fnd%2F%2B6X8fTU1FGvHGhrCsRiiiJlSrvXpirQbrvAGZpOnsYgmrpN%2BMpWtvOv6rtT4KOAGuC3VoE6Z7gVoIEb0SjgvuRvs%2FWKJzHlrbPelrZG0TyA2gh%2FjTt63wIn5KD3Taw6Fle6Oou4tA25TCV9YEn6ad2i2b08s60zG%2Fq1PgyO7uxmRO9bArVF0XJeoMMwUyJjIywFTXFKM4FlzjIsB2mS5rmUQ5mEl7ARALpXARA1qEsFOrU04IXxBUpokmLGMKNbmvMB48NRnOX5B4re74rCSuhXSMKvtHsQ8Y%2BHEK7c5XY0ud%2FedrLWZRzqvS6VtCfcCufhJgHsmDwmhWDy11dMfgA%3D
samlrequest: jZJBT+MwFITv/Arr3RPHaVoaqynqLqpAC2pEUg5cVq7rttYmdtbPqeDf402plgMCLr54RjOez7Or57YhR+VQW1MAixMgyki71WZfwLpeRlO4ml/MULRNl/JF7w/mQf3tFXoSnAb56aaA3hluBWrkRrQKuZe8Wtzf8TROeOest9I2QBaIyvmQ9dMa7FvlKuWOWqr1w10BB+875JR2/abRMsbT1cY+R51wHmNpW7rX+xdRVSsg16GDNsIPxc/Wnd62sepZPOgGx7+C9Bhq0Oy3dct2/euG1c6UyZ/73ejgXtyC6m1HES2QpXVSDY8sYCcaVEBurwuQl1KK0VhGGRN5lI1lGuVqGo58kuW5zMYsmwQllgJRH9V/L2Kvbg16YXwBaZJmEWMRS+ok5yPGx5N4mudPQMq3fX5ocxr+szE3JxHym7ouo3JV1UAezwCDAN5wpXyId+84fYFJnOHA/DsowmIz+j4pBNMPPsr8FQ==
server: Apache/2.4.57 (Unix) OpenSSL/3.0.9
content-length: 0'

HTTP_REQ="${test_HTTP_REQ}"

if [[ -z "${HTTP_REQ}" ]]
then

    HTTP_REQ=$(curl \
		    -s \
		    -D - \
		    -A "${USERAGENT}" \
		    -X POST \
		    --cookie "${SET_BIGIPSERVER}" \
		    --cookie "${SET_PSA_COUNTRY}" \
 		    --cookie "${SET_JSESSIONID}" \
 		    -d '' \
 		    "${PUBLIC_SERVICE_BOX_ROOT_URL}/getSamlReq"
	     )
fi

echo "==> HTTP_REQ: ${HTTP_REQ}" 1>&2

myGIGYAURL=$( echo "${HTTP_REQ}" | sed -n -e '/^gigya[uU]rl:/s/^gigya[uU]rl:[ \t]*\(.*\)$/\1/p' )
myAPIKEY=$( echo "${GIGYAURL}" | sed -n -e 's|.*/v2.0/\([^/]*\)/.*$|\1|p' )

while IFS= read -r header
do
        if [[ $header == *"gigyaUrl"* ]]; then
                GIGYAURL=$(echo -n $header | sed 's/^gigyaUrl: \(.*\)\r/\1/i')
                APIKEY=$(echo $header | sed 's/.*v2.0\/\([a-zA-Z0-9\-_]*\)\/.*$/\1/i')
        fi
        if [[ $header == *"SAMLRequest"* ]]; then
                SAMLREQUEST=$(echo -n $header | sed 's/^SAMLRequest: \(.*\)\r/\1/i')
                SAMLREQUEST_ENCODED=$(urlencode $SAMLREQUEST)
        fi
done <<< "$HTTP_REQ"

(
    echo "GIGYAURL"
    echo "==> $GIGYAURL"
    echo "==> $myGIGYAURL"

    echo "APIKEY"
    echo $APIKEY
    echo $myAPIKEY
) 1>&2


exit 1

echo 'Content-type: text/html'
echo 'RespHead: ABC'
echo "Set-Cookie: eee=1"
echo
echo '<html>
<head>
<title>HELLO cgi</title>
</head>'

html_log_message "$( date )"
html_log_message '==================================='
html_log_message "$(env)"
html_log_message "Query string array: ${query_string_array[@]}"
html_log_message "${HTTP_COOKIE}"

cat /tmp/zz.log

echo '</span>
</span>
</p>

</body>
</html>
'



exit 0



# IMPORTED OCDE



LOGIN=""
PASSWORD=""
TIME=$(date +"%H:%M")
USERAGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:132.0) Gecko/20100101 Firefox/132.0"

urlencode() {
    # urlencode <string>

    old_lc_collate=$LC_COLLATE
    LC_COLLATE=C

    local length="${#1}"
    for (( i = 0; i < length; i++ )); do
        local c="${1:$i:1}"
        case $c in
            [a-zA-Z0-9.~_-]) printf '%s' "$c" ;;
            *) printf '%%%02X' "'$c" ;;
        esac
    done

    LC_COLLATE=$old_lc_collate
}

LOGIN_TOKEN=""

HTTP_REQ=$(curl -s -D - -A "${USERAGENT}" -X GET "https://public.servicebox-parts.com/")
while IFS= read -r header
do
    if [[ $header == "Set-Cookie: JSESSIONID"* ]]; then
                JSESSIONID=$(echo $header | sed 's/^Set-Cookie: \([^;]*;\).*$/\1
/i')
        fi
        if [[ $header == "Set-Cookie: BIGipServer"* ]]; then
                BIGIPSERVER=$(echo $header | sed 's/^Set-Cookie: \([^;]*;\).*$/\
1/i')
        fi
        if [[ $header == "Set-Cookie: PSACountry"* ]]; then
                PSACOUNTRY=$(echo $header | sed 's/^Set-Cookie: \([^;]*;\).*$/\1
/i')
        fi
done <<< "$HTTP_REQ"

HTTP_REQ=$(curl -s -D - -A "${USERAGENT}" -X POST "https://public.servicebox-parts.com/getSamlReq" -H "Cookie: ${JSESSIONID} ${PSACOUNTRY} ${BIGIPSERVER} " -d "")
while IFS= read -r header
do
        if [[ $header == *"gigyaUrl"* ]]; then
                GIGYAURL=$(echo -n $header | sed 's/^gigyaUrl: \(.*\)\r/\1/i')
                APIKEY=$(echo $header | sed 's/.*v2.0\/\([a-zA-Z0-9\-_]*\)\/.*$/\1/i')
        fi
        if [[ $header == *"SAMLRequest"* ]]; then
                SAMLREQUEST=$(echo -n $header | sed 's/^SAMLRequest: \(.*\)\r/\1/i')
                SAMLREQUEST_ENCODED=$(urlencode $SAMLREQUEST)
        fi
done <<< "$HTTP_REQ"

HTTP_REQ=$(curl -s -D - -A "${USERAGENT}" -X GET "${GIGYAURL}?SAMLRequest=${SAMLREQUEST_ENCODED}")
while IFS= read -r header
do
        if [[ $header == *"samlContext="* ]]; then
                SAMLCONTEXT=$(echo -n $header | sed 's/.*samlContext=\([^&]*\).*/\1/i')
        fi
done <<< "$HTTP_REQ"

HTTP_REQ=$(curl -s -D - -A "${USERAGENT}" -X GET "https://login-ra.fiat.com/accounts.webSdkBootstrap?apiKey=${APIKEY}&pageURL=${GIGYAURL}?SAMLRequest=${SAMLREQUEST}&sdk=js_latest&sdkBuild=16506&format=json")
while IFS= read -r header
do
        if [[ $header == *"gmid="* ]]; then
                GMID=$(echo $header | sed 's/^Set-Cookie: \([^;]*;\).*$/\1/i')
        fi
        if [[ $header == *"ucid="* ]]; then
                UCID=$(echo $header | sed 's/^Set-Cookie: \([^;]*;\).*$/\1/i')
        fi
        if [[ $header == *"hasGmid="* ]]; then
                HASGMID=$(echo $header | sed 's/^Set-Cookie: \([^;]*;\).*$/\1/i')
        fi
done <<< "$HTTP_REQ"

RISKCONTEXT=$(urlencode "{\"b0\":53295,\"b1\":[104,68,180,220],\"b2\":6,\"b3\":[],\"b4\":6,\"b5\":1,\"b6\":\"${USERAGENT}\",\"b7\":[],\"b8\":\"${TIME}:
00\",\"b9\":-120,\"b10\":{\"state\":\"prompt\"},\"b11\":false,\"b12\":{\"charging\":true,\"chargingTime\":0,\"dischargingTime\":null,\"level\":1},\"b13
\":[null,\"1024|728|24\",false,true]}")

HTTP_REQ=$(curl -s -D - -A "${USERAGENT}" -X POST "https://login-ra.fiat.com/accounts.login" -d "loginID=${LOGIN}&password=${PASSWORD}&sessionExpiratio
n=2628000&targetEnv=jssdk&include=profile%2Cdata%2Cemails%2Csubscriptions%2Cpreferences%2C&includeUserInfo=true&loginMode=standard&lang=fr&riskContext=
${RISKCONTEXT}&APIKey=${APIKEY}&source=showScreenSet&sdk=js_latest&authMode=cookie&pageURL=https%3A%2F%2Flogin-ra.fiat.com%2F&sdkBuild=16506&format=jso
n" -H "Cookie: ${GMID} ${UCID} ${HASGMID} ")
while IFS= read -r header
do
        if [[ $header == *"glt_"* ]]; then
                GLT=$(echo $header | sed 's/^Set-Cookie: \([^;]*;\).*$/\1/i')
                LOGIN_TOKEN=$(echo $header | sed 's/^Set-Cookie: [^=]*=\([^;]*\);.*$/\1/i')
        fi
done <<< "$HTTP_REQ"

if [[ $LOGIN_TOKEN == "" ]]; then
        echo "Login ERROR"
        exit 1
fi

HTTP_REQ=$(curl -s -A "${USERAGENT}" -X GET "https://login-ra.fiat.com/saml/v2.0/${APIKEY}/idp/sso/continue?samlContext=${SAMLCONTEXT}&loginToken=${LOG
IN_TOKEN}" -H "Cookie: ${GMID} ${UCID} ${HASGMID} ")
while IFS= read -r data
do
        if [[ $data == *"SAMLResponse"* ]]; then
                SAMLRESPONSE=$(echo $data | sed 's/.* name="SAMLResponse" value="\([^"]*\).*$/\1/i')
                SAMLRESPONSE_ENCODED=$(urlencode $SAMLRESPONSE)
                SERVICEBOX_URL=$(echo $data | sed 's/.* method="post" action="\([^"]*\).*$/\1/i')
        fi
done <<< "$HTTP_REQ"

HTTP_REQ=$(curl -s -D - -A "${USERAGENT}" -X POST "${SERVICEBOX_URL}" -d "SAMLResponse=${SAMLRESPONSE_ENCODED}" -H "Cookie: ${JSESSIONID} ${PSACOUNTRY} ${BIGIPSERVER} ")

echo "${JSESSIONID} ${PSACOUNTRY} ${BIGIPSERVER} "
